// Prisma schema for ExamFlow EIMS
// Database: SQLite (can easily migrate to PostgreSQL for production)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Authentication
// ============================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  firstName    String
  lastName     String
  role         Role     @default(STUDENT)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  student           Student?
  faculty           Faculty?
  createdExams      Exam[]            @relation("ExamCreator")
  announcements     Announcement[]
  auditLogs         AuditLog[]
  regradeRequests   RegradeRequest[]  @relation("RegradeRequester")
  regradeResponses  RegradeRequest[]  @relation("RegradeResponder")
  refreshTokens     RefreshToken[]
  notifications     Notification[]

  @@index([email])
  @@index([role])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

enum Role {
  ADMIN
  FACULTY
  STUDENT
}

// ============================================
// Student & Faculty Profiles
// ============================================

model Student {
  id            String   @id @default(uuid())
  userId        String   @unique
  studentNumber String   @unique
  program       String
  yearLevel     Int
  section       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments     Enrollment[]
  examResults     ExamResult[]
  regradeRequests RegradeRequest[]

  @@index([studentNumber])
  @@index([program])
}

model Faculty {
  id           String   @id @default(uuid())
  userId       String   @unique
  facultyId    String   @unique
  department   String
  designation  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courses Course[]

  @@index([facultyId])
}

// ============================================
// Courses & Enrollment
// ============================================

model Course {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  description String?
  units       Int      @default(3)
  facultyId   String?
  semester    String   // e.g., "1st Sem 2024-2025"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  faculty     Faculty?     @relation(fields: [facultyId], references: [id])
  enrollments Enrollment[]
  exams       Exam[]

  @@index([code])
  @@index([semester])
}

model Enrollment {
  id        String   @id @default(uuid())
  studentId String
  courseId  String
  status    EnrollmentStatus @default(ENROLLED)
  createdAt DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
}

enum EnrollmentStatus {
  ENROLLED
  DROPPED
  COMPLETED
}

// ============================================
// Exams & Schedules
// ============================================

model Exam {
  id           String     @id @default(uuid())
  title        String
  description  String?
  courseId     String
  createdById  String
  type         ExamType   @default(WRITTEN)
  status       ExamStatus @default(DRAFT)
  totalPoints  Int        @default(100)
  passingScore Int        @default(60)
  guidelines   String?    // Exam guidelines/instructions
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  course        Course          @relation(fields: [courseId], references: [id])
  createdBy     User            @relation("ExamCreator", fields: [createdById], references: [id])
  schedules     ExamSchedule[]
  results       ExamResult[]
  announcements Announcement[]
  files         ExamFile[]

  @@index([courseId])
  @@index([status])
  @@index([createdById])
}

model ExamSchedule {
  id        String   @id @default(uuid())
  examId    String
  section   String?  // Specific section, null = all sections
  room      String?  // Physical room or null for online
  meetLink  String?  // Online meeting link
  startTime DateTime
  endTime   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  exam Exam @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@index([examId])
  @@index([startTime])
}

model ExamFile {
  id           String   @id @default(uuid())
  examId       String
  filename     String
  originalName String
  mimeType     String
  size         Int
  checksum     String   // SHA-256 hash for integrity
  uploadedAt   DateTime @default(now())

  exam Exam @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@index([examId])
}

enum ExamType {
  WRITTEN
  ORAL
  PRACTICAL
  ONLINE
  TAKE_HOME
}

enum ExamStatus {
  DRAFT
  SCHEDULED
  ONGOING
  COMPLETED
  CANCELLED
}

// ============================================
// Results & Regrade Requests
// ============================================

model ExamResult {
  id          String       @id @default(uuid())
  examId      String
  studentId   String
  score       Float
  remarks     String?
  status      ResultStatus @default(PENDING)
  publishedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  exam            Exam             @relation(fields: [examId], references: [id], onDelete: Cascade)
  student         Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  regradeRequests RegradeRequest[]

  @@unique([examId, studentId])
  @@index([examId])
  @@index([studentId])
  @@index([status])
}

model RegradeRequest {
  id          String        @id @default(uuid())
  resultId    String
  studentId   String
  requesterId String
  reason      String
  status      RegradeStatus @default(PENDING)
  response    String?
  responderId String?
  respondedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  result    ExamResult @relation(fields: [resultId], references: [id], onDelete: Cascade)
  student   Student    @relation(fields: [studentId], references: [id])
  requester User       @relation("RegradeRequester", fields: [requesterId], references: [id])
  responder User?      @relation("RegradeResponder", fields: [responderId], references: [id])

  @@index([resultId])
  @@index([studentId])
  @@index([status])
}

enum ResultStatus {
  PENDING
  PUBLISHED
  UNDER_REVIEW
}

enum RegradeStatus {
  PENDING
  APPROVED
  REJECTED
  RESOLVED
}

// ============================================
// Announcements & Notifications
// ============================================

model Announcement {
  id          String             @id @default(uuid())
  title       String
  content     String
  type        AnnouncementType   @default(GENERAL)
  priority    AnnouncementPriority @default(NORMAL)
  examId      String?            // Optional: linked to specific exam
  createdById String
  targetRoles String             // Comma-separated roles: "STUDENT,FACULTY"
  publishedAt DateTime           @default(now())
  expiresAt   DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  exam          Exam?          @relation(fields: [examId], references: [id])
  createdBy     User           @relation(fields: [createdById], references: [id])
  notifications Notification[]

  @@index([examId])
  @@index([createdById])
  @@index([publishedAt])
  @@index([type])
}

model Notification {
  id             String   @id @default(uuid())
  userId         String
  announcementId String?
  type           String   // announcement, schedule_update, result_published, etc.
  title          String
  message        String
  isRead         Boolean  @default(false)
  isAcknowledged Boolean  @default(false) // For reliable delivery tracking
  retryCount     Int      @default(0)
  createdAt      DateTime @default(now())
  readAt         DateTime?

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  announcement Announcement? @relation(fields: [announcementId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([isRead])
  @@index([isAcknowledged])
  @@index([createdAt])
}

enum AnnouncementType {
  GENERAL
  EXAM_UPDATE
  SCHEDULE_CHANGE
  RESULT_RELEASE
  PROCTOR_NOTICE
  EMERGENCY
}

enum AnnouncementPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ============================================
// Audit Logging
// ============================================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  entity     String   // User, Exam, Result, etc.
  entityId   String?
  changes    String?  // JSON string of changes
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entity])
  @@index([action])
  @@index([timestamp])
}
